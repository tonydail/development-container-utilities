#!/usr/local/bin/bash

# Development Container Template Manager (DCTM)
# Main menu interface for managing development container templates

# Get the script directory and set up paths
SCRIPT_DIR="$(realpath "$(dirname "$0")")"
HELPER_SCRIPTS_DIR="$SCRIPT_DIR/helper_scripts"
TEMPLATES_DIR="$(realpath "$SCRIPT_DIR/../blueprints/templates")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to display the main menu
show_main_menu() {
    clear
    echo -e "${CYAN}==========================================${NC}"
    echo -e "${CYAN}  Development Container Template Manager${NC}"
    echo -e "${CYAN}==========================================${NC}"
    echo ""
    echo -e "${GREEN}1)${NC} Apply Template"
    echo -e "${GREEN}2)${NC} Template Info"
    echo -e "${GREEN}3)${NC} Cleanup Template Environment"
    echo -e "${GREEN}4)${NC} Exit"
    echo ""
    echo -n -e "${YELLOW}Please select an option (1-4): ${NC}"
}

# Function to get available template names (returns array of names)
get_template_names() {
    local templates=()
    
    if [ -d "$TEMPLATES_DIR" ]; then
        for template in "$TEMPLATES_DIR"/*.json; do
            if [ -f "$template" ]; then
                template_name=$(basename "$template")
                templates+=("$template_name")
            fi
        done
    fi
    
    if [ ${#templates[@]} -eq 0 ]; then
        return 1
    fi
    
    echo "${templates[@]}"
}

# Function to display available templates with numbers
display_templates() {
    echo -e "\n${BLUE}Available Templates:${NC}"
    local template_count=0
    
    if [ -d "$TEMPLATES_DIR" ]; then
        for template in "$TEMPLATES_DIR"/*.json; do
            if [ -f "$template" ]; then
                template_count=$((template_count + 1))
                template_name=$(basename "$template")
                echo -e "${GREEN}$template_count)${NC} $template_name"
            fi
        done
    fi
    
    if [ $template_count -eq 0 ]; then
        echo -e "${RED}No templates found in $TEMPLATES_DIR${NC}"
        return 1
    fi
    
    return 0
}

# Function to apply a template
apply_template() {
    echo -e "\n${BLUE}=== Apply Template ===${NC}"
    
    # Display templates to user
    if ! display_templates; then
        echo -e "${RED}No templates available to apply.${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    # Get template names for processing
    local templates_output
    templates_output=$(get_template_names)
    local templates=()
    read -ra templates <<< "$templates_output"
    
    echo ""
    echo -n -e "${YELLOW}Select template number (or 'q' to quit): ${NC}"
    read -r selection
    
    if [ "$selection" = "q" ] || [ "$selection" = "Q" ]; then
        return
    fi
    
    # Validate selection
    if ! [[ "$selection" =~ ^[0-9]+$ ]] || [ "$selection" -lt 1 ] || [ "$selection" -gt ${#templates[@]} ]; then
        echo -e "${RED}Invalid selection.${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    local template_file="${templates[$((selection-1))]}"
    
    echo -e "\n${BLUE}Applying template: ${CYAN}$template_file${NC}"
    
    # Check if template builder script exists
    if [ ! -f "$HELPER_SCRIPTS_DIR/template_builder_helpers.sh" ]; then
        echo -e "${RED}Template builder script not found at $HELPER_SCRIPTS_DIR/template_builder_helpers.sh${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    # Apply the template
    echo -e "${YELLOW}Building template...${NC}"
    if bash "$HELPER_SCRIPTS_DIR/template_builder_helpers.sh" build "$template_file"; then
        echo -e "${GREEN}Template applied successfully!${NC}"
        echo -e "${BLUE}DevContainer configuration has been created in .devcontainer/ directory${NC}"
    else
        echo -e "${RED}Failed to apply template.${NC}"
    fi
    
    read -p "Press Enter to continue..."
}

# Function to show template information
template_info() {
    echo -e "\n${BLUE}=== Template Information ===${NC}"
    
    # Display templates to user
    if ! display_templates; then
        echo -e "${RED}No templates available.${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    # Get template names for processing
    local templates_output
    templates_output=$(get_template_names)
    local templates=()
    read -ra templates <<< "$templates_output"
    
    echo ""
    echo -n -e "${YELLOW}Select template number for info (or 'q' to quit): ${NC}"
    read -r selection
    
    if [ "$selection" = "q" ] || [ "$selection" = "Q" ]; then
        return
    fi
    
    # Validate selection
    if ! [[ "$selection" =~ ^[0-9]+$ ]] || [ "$selection" -lt 1 ] || [ "$selection" -gt ${#templates[@]} ]; then
        echo -e "${RED}Invalid selection.${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    local template_file="${templates[$((selection-1))]}"
    local template_path="$TEMPLATES_DIR/$template_file"
    
    echo -e "\n${PURPLE}=== Template Details ===${NC}"
    echo -e "${CYAN}File:${NC} $template_file"
    echo -e "${CYAN}Path:${NC} $template_path"
    echo ""
    
    if [ -f "$template_path" ]; then
        # Extract and display template information using jq if available
        if command -v jq >/dev/null 2>&1; then
            echo -e "${CYAN}Name:${NC} $(jq -r '.name // "N/A"' "$template_path")"
            echo -e "${CYAN}Description:${NC}"
            jq -r '.description // "N/A"' "$template_path" | sed 's/^/  /'
            echo ""
            echo -e "${CYAN}Components:${NC}"
            jq -r '.components[] | "  - \(.component) (build order: \(."build-order"))"' "$template_path"
        else
            echo -e "${YELLOW}jq not available. Showing raw JSON:${NC}"
            cat "$template_path"
        fi
    else
        echo -e "${RED}Template file not found.${NC}"
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# Function to cleanup template environment
cleanup_environment() {
    echo -e "\n${BLUE}=== Cleanup Template Environment ===${NC}"
    echo -e "${YELLOW}This will remove Docker containers, images, networks, and volumes${NC}"
    echo -e "${YELLOW}created by development container templates.${NC}"
    echo ""
    echo -n -e "${RED}Are you sure you want to continue? (y/N): ${NC}"
    read -r confirmation
    
    if [ "$confirmation" != "y" ] && [ "$confirmation" != "Y" ]; then
        echo -e "${BLUE}Cleanup cancelled.${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    # Check if cleanup script exists
    if [ ! -f "$HELPER_SCRIPTS_DIR/cleanupenvironment.sh" ]; then
        echo -e "${RED}Cleanup script not found at $HELPER_SCRIPTS_DIR/cleanupenvironment.sh${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    echo -e "\n${YELLOW}Running cleanup script...${NC}"
    if bash "$HELPER_SCRIPTS_DIR/cleanupenvironment.sh"; then
        echo -e "${GREEN}Environment cleanup completed successfully!${NC}"
    else
        echo -e "${RED}Cleanup script encountered some issues.${NC}"
    fi
    
    read -p "Press Enter to continue..."
}

# Function to handle exit
exit_program() {
    echo -e "\n${GREEN}Thank you for using Development Container Template Manager!${NC}"
    exit 0
}

# Main program loop
main() {
    # Check if required directories exist
    if [ ! -d "$TEMPLATES_DIR" ]; then
        echo -e "${RED}Templates directory not found: $TEMPLATES_DIR${NC}"
        exit 1
    fi
    
    if [ ! -d "$HELPER_SCRIPTS_DIR" ]; then
        echo -e "${RED}Helper scripts directory not found: $HELPER_SCRIPTS_DIR${NC}"
        exit 1
    fi
    
    while true; do
        show_main_menu
        read -r choice
        
        case $choice in
            1)
                apply_template
                ;;
            2)
                template_info
                ;;
            3)
                cleanup_environment
                ;;
            4)
                exit_program
                ;;
            *)
                echo -e "\n${RED}Invalid option. Please select 1-4.${NC}"
                sleep 2
                ;;
        esac
    done
}

# Run the main program
main "$@"
